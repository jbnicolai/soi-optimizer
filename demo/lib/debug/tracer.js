/** Oslo JavaScript Framework. */
define(["../util/util","../array/array","../iter/util","../log/log","../ds/map","../ds/simplepool","../debug/logger"],function(a,b,c,d,e,f,g){"use strict";var h=function(){this.events_=[],this.outstandingEvents_=new e,this.startTime_=0,this.tracerOverheadStart_=0,this.tracerOverheadEnd_=0,this.tracerOverheadComment_=0,this.stats_=new e,this.tracerCount_=0,this.commentCount_=0,this.nextId_=1,this.eventPool_=new f(0,4e3),this.eventPool_.createObject=function(){return new h.Event_},this.statPool_=new f(0,50),this.statPool_.createObject=function(){return new h.Stat_};var a=this;this.idPool_=new f(0,2e3),this.idPool_.createObject=function(){return String(a.nextId_++)},this.idPool_.disposeObject=function(){},this.defaultThreshold_=3};return h.prototype.logger_=d.getLogger("Oslo.debug.Trace"),h.prototype.MAX_TRACE_SIZE=1e3,h.EventType={START:0,STOP:1,COMMENT:2},h.Stat_=function(){this.count=0,this.time=0,this.varAlloc=0},h.Stat_.prototype.type,h.Stat_.prototype.toString=function(){var a=[];return a.push(this.type," ",this.count," (",Math.round(10*this.time)/10," ms)"),this.varAlloc&&a.push(" [VarAlloc = ",this.varAlloc,"]"),a.join("")},h.Event_=function(){},h.Event_.prototype.type,h.Event_.prototype.toTraceString=function(a,b,c){var d=[];if(-1==b?d.push("    "):d.push(h.longToPaddedString_(this.eventTime-b)),d.push(" ",h.formatTime_(this.eventTime-a)),this.eventType==h.EventType.START)d.push(" Start        ");else if(this.eventType==h.EventType.STOP){d.push(" Done ");var e=this.stopTime-this.startTime;d.push(h.longToPaddedString_(e)," ms ")}else d.push(" Comment      ");return d.push(c,this),this.totalVarAlloc>0&&d.push("[VarAlloc ",this.totalVarAlloc,"] "),d.join("")},h.Event_.prototype.toString=function(){return null==this.type?this.comment:"["+this.type+"] "+this.comment},h.prototype.setStartTime=function(a){this.startTime_=a},h.prototype.initCurrentTrace=function(a){this.reset(a)},h.prototype.clearCurrentTrace=function(){this.reset(0)},h.prototype.reset=function(a){this.defaultThreshold_=a;for(var b=0;b<this.events_.length;b++){var c=this.eventPool_.id;c&&this.idPool_.releaseObject(c),this.eventPool_.releaseObject(this.events_[b])}this.events_.length=0,this.outstandingEvents_.clear(),this.startTime_=h.now(),this.tracerOverheadStart_=0,this.tracerOverheadEnd_=0,this.tracerOverheadComment_=0,this.tracerCount_=0,this.commentCount_=0;for(var d=this.stats_.getKeys(),b=0;b<d.length;b++){var e=d[b],f=this.stats_.get(e);f.count=0,f.time=0,f.varAlloc=0,this.statPool_.releaseObject(f)}this.stats_.clear()},h.prototype.startTracer=function(a,b){var c=h.now(),e=this.getTotalVarAlloc(),f=this.outstandingEvents_.getCount();if(this.events_.length+f>this.MAX_TRACE_SIZE){if(d.warning(this.logger_,"Giant thread trace. Clearing to avoid memory leak."),this.events_.length>this.MAX_TRACE_SIZE/2){for(var i=0;i<this.events_.length;i++){var j=this.events_[i];j.id&&this.idPool_.releaseObject(j.id),this.eventPool_.releaseObject(j)}this.events_.length=0}f>this.MAX_TRACE_SIZE/2&&this.outstandingEvents_.clear()}g.logToProfilers("Start : "+a);var j=this.eventPool_.getObject();j.totalVarAlloc=e,j.eventType=h.EventType.START,j.id=Number(this.idPool_.getObject()),j.comment=a,j.type=b,this.events_.push(j),this.outstandingEvents_.set(String(j.id),j),this.tracerCount_++;var k=h.now();return j.startTime=j.eventTime=k,this.tracerOverheadStart_+=k-c,j.id},h.prototype.stopTracer=function(a,b){var c,d=h.now();c=0===b?0:b?b:this.defaultThreshold_;var e=this.outstandingEvents_.get(String(a));if(null==e)return null;this.outstandingEvents_.remove(String(a));var f,i=d-e.startTime;if(c>i)for(var j=this.events_.length,k=j-1;k>=0;k--){var l=this.events_[k];if(l==e){this.events_.splice(k,1),this.idPool_.releaseObject(e.id),this.eventPool_.releaseObject(e);break}}else f=this.eventPool_.getObject(),f.eventType=h.EventType.STOP,f.startTime=e.startTime,f.comment=e.comment,f.type=e.type,f.stopTime=f.eventTime=d,this.events_.push(f);var m=e.type,n=null;m&&(n=this.getStat_(m),n.count++,n.time+=i),f&&(g.logToProfilers("Stop : "+f.comment),f.totalVarAlloc=this.getTotalVarAlloc(),n&&(n.varAlloc+=f.totalVarAlloc-e.totalVarAlloc));var o=h.now();return this.tracerOverheadEnd_+=o-d,i},h.prototype.setGcTracer=function(a){this.gcTracer_=a},h.prototype.getTotalVarAlloc=function(){var a=this.gcTracer_;return a&&a.isTracing()?a.totalVarAlloc:-1},h.prototype.addComment=function(a,c,d){var e=h.now(),f=d?d:e,g=this.eventPool_.getObject();if(g.eventType=h.EventType.COMMENT,g.eventTime=f,g.type=c,g.comment=a,g.totalVarAlloc=this.getTotalVarAlloc(),this.commentCount_++,d){for(var i=this.events_.length,j=0;i>j;j++){var k=this.events_[j],l=k.eventTime;if(l>f){b.insertAt(this.events_,g,j);break}}j==i&&this.events_.push(g)}else this.events_.push(g);var m=g.type;if(m){var n=this.getStat_(m);n.count++}this.tracerOverheadComment_+=h.now()-e},h.prototype.getStat_=function(a){var b=this.stats_.get(a);return b||(b=this.statPool_.getObject(),b.type=a,this.stats_.set(a,b)),b},h.prototype.getFormattedTrace=function(){return this.toString()},h.prototype.toString=function(){for(var a=[],b=-1,d=[],e=0;e<this.events_.length;e++){var f=this.events_[e];f.eventType==h.EventType.STOP&&d.pop(),a.push(" ",f.toTraceString(this.startTime_,b,d.join(""))),b=f.eventTime,a.push("\n"),f.eventType==h.EventType.START&&d.push("|  ")}if(0!=this.outstandingEvents_.getCount()){var g=h.now();a.push(" Unstopped timers:\n"),c.forEach(this.outstandingEvents_,function(b){a.push("  ",b," (",g-b.startTime," ms, started at ",h.formatTime_(b.startTime),")\n")})}for(var i=this.stats_.getKeys(),e=0;e<i.length;e++){var j=this.stats_.get(i[e]);j.count>1&&a.push(" TOTAL ",j,"\n")}return a.push("Total tracers created ",this.tracerCount_,"\n","Total comments created ",this.commentCount_,"\n","Overhead start: ",this.tracerOverheadStart_," ms\n","Overhead end: ",this.tracerOverheadEnd_," ms\n","Overhead comment: ",this.tracerOverheadComment_," ms\n"),a.join("")},h.longToPaddedString_=function(a){a=Math.round(a);var b="";return 1e3>a&&(b=" "),100>a&&(b="  "),10>a&&(b="   "),b+a},h.formatTime_=function(a){a=Math.round(a);var b=a/1e3%60,c=a%1e3;return String(100+b).substring(1,3)+"."+String(1e3+c).substring(1,4)},h.now=function(){return a.now()},new h});