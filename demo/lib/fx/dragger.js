/** Oslo JavaScript Framework. */
define(["../util/util","../dom/util","../events/util","../events/eventbase","../events/handlermanager","../events/eventtarget","../events/eventtype","../math/coordinate","../math/rect","../style/util","../style/bidi","../ua/util","./draggereventtype","./dragevent"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){"use strict";var o=function(a,d,h){f.call(this),this.target=a,this.handle=d||a,this.limits=h||new i(0/0,0/0,0/0,0/0),this.document_=b.getOwnerDocument(a),this.handlerManager_=new e(this),this.registerDisposable(this.handlerManager_),c.listen(this.handle,[g.TOUCHSTART,g.MOUSEDOWN],this.startDrag,!1,this)};return a.inherits(o,f),o.HAS_SET_CAPTURE_=l.isIE||l.isGECKO&&l.isVersionOrHigher("1.9.3"),o.prototype.target=null,o.prototype.handle=null,o.prototype.limits=null,o.prototype.rightToLeft_=null,o.prototype.clientX=0,o.prototype.clientY=0,o.prototype.startX=0,o.prototype.startY=0,o.prototype.deltaX=0,o.prototype.deltaY=0,o.prototype.pageScroll=null,o.prototype.enabled_=!0,o.prototype.dragging_=!1,o.prototype.hysteresisDistanceSquared_=0,o.prototype.mouseDownTime_=0,o.prototype.document_=null,o.prototype.scrollTarget_=null,o.prototype.ieDragStartCancellingOn_=!1,o.prototype.useRightPositioningForRtl_=!1,o.prototype.enableRightPositioningForRtl=function(a){this.useRightPositioningForRtl_=a},o.prototype.getHandler=function(){return this.handlerManager_},o.prototype.setLimits=function(a){this.limits=a||new i(0/0,0/0,0/0,0/0)},o.prototype.setHysteresis=function(a){this.hysteresisDistanceSquared_=Math.pow(a,2)},o.prototype.getHysteresis=function(){return Math.sqrt(this.hysteresisDistanceSquared_)},o.prototype.setScrollTarget=function(a){this.scrollTarget_=a},o.prototype.setCancelIeDragStart=function(a){this.ieDragStartCancellingOn_=a},o.prototype.getEnabled=function(){return this.enabled_},o.prototype.setEnabled=function(a){this.enabled_=a},o.prototype.disposeInternal=function(){o.superClass_.disposeInternal.call(this),c.unlisten(this.handle,[g.TOUCHSTART,g.MOUSEDOWN],this.startDrag,!1,this),this.cleanUpAfterDragging_(),this.target=null,this.handle=null},o.prototype.isRightToLeft_=function(){return a.isDef(this.rightToLeft_)||(this.rightToLeft_=j.isRightToLeft(this.target)),this.rightToLeft_},o.prototype.startDrag=function(c){var d=c.type===g.MOUSEDOWN;if(!this.enabled_||this.dragging_||d&&!c.isMouseActionButton())this.dispatchEvent(m.EARLY_CANCEL);else{if(this.maybeReinitTouchEvent_(c),0===this.hysteresisDistanceSquared_){if(!this.fireDragStart_(c))return;this.dragging_=!0,c.preventDefault()}else c.preventDefault();this.setupDragHandlers(),this.clientX=this.startX=c.clientX,this.clientY=this.startY=c.clientY,this.deltaX=this.useRightPositioningForRtl_?k.getOffsetStart(this.target):this.target.offsetLeft,this.deltaY=this.target.offsetTop,this.pageScroll=b.getDomHelper(this.document_).getDocumentScroll(),this.mouseDownTime_=a.now()}},o.prototype.setupDragHandlers=function(){var a=this.document_,c=a.documentElement,e=!o.HAS_SET_CAPTURE_;this.handlerManager_.listen(a,[g.TOUCHMOVE,g.MOUSEMOVE],this.handleMove_,e),this.handlerManager_.listen(a,[g.TOUCHEND,g.MOUSEUP],this.endDrag,e),o.HAS_SET_CAPTURE_?(c.setCapture(!1),this.handlerManager_.listen(c,g.LOSECAPTURE,this.endDrag)):this.handlerManager_.listen(b.getWindow(a),g.BLUR,this.endDrag),l.isIE&&this.ieDragStartCancellingOn_&&this.handlerManager_.listen(a,g.DRAGSTART,d.preventDefault),this.scrollTarget_&&this.handlerManager_.listen(this.scrollTarget_,g.SCROLL,this.onScroll_,e)},o.prototype.fireDragStart_=function(a){return this.dispatchEvent(new n(m.START,this,a.clientX,a.clientY,a))},o.prototype.cleanUpAfterDragging_=function(){this.handlerManager_.removeAll(),o.HAS_SET_CAPTURE_&&this.document_.releaseCapture()},o.prototype.endDrag=function(a,b){if(this.cleanUpAfterDragging_(),this.dragging_){this.maybeReinitTouchEvent_(a),this.dragging_=!1;var c=this.limitX(this.deltaX),d=this.limitY(this.deltaY),e=b||a.type===g.TOUCHCANCEL;this.dispatchEvent(new n(m.END,this,a.clientX,a.clientY,a,c,d,e))}else this.dispatchEvent(m.EARLY_CANCEL)},o.prototype.endDragCancel=function(a){this.endDrag(a,!0)},o.prototype.maybeReinitTouchEvent_=function(a){var b=a.type;b===g.TOUCHSTART||b===g.TOUCHMOVE?a.init(a.getBrowserEvent().targetTouches[0],a.currentTarget):(b===g.TOUCHEND||b===g.TOUCHCANCEL)&&a.init(a.getBrowserEvent().changedTouches[0],a.currentTarget)},o.prototype.handleMove_=function(a){if(this.enabled_){this.maybeReinitTouchEvent_(a);var b=this.useRightPositioningForRtl_&&this.isRightToLeft_()?-1:1,c=b*(a.clientX-this.clientX),d=a.clientY-this.clientY;if(this.clientX=a.clientX,this.clientY=a.clientY,!this.dragging_){var e=this.startX-this.clientX,f=this.startY-this.clientY,g=e*e+f*f;if(g>this.hysteresisDistanceSquared_){if(!this.fireDragStart_(a))return this.isDisposed()||this.endDrag(a),void 0;this.dragging_=!0}}var h=this.calculatePosition_(c,d),i=h.x,j=h.y;if(this.dragging_){var k=this.dispatchEvent(new n(m.BEFOREDRAG,this,a.clientX,a.clientY,a,i,j));k&&(this.doDrag(a,i,j,!1),a.preventDefault())}}},o.prototype.calculatePosition_=function(a,c){var d=b.getDomHelper(this.document_).getDocumentScroll();a+=d.x-this.pageScroll.x,c+=d.y-this.pageScroll.y,this.pageScroll=d,this.deltaX+=a,this.deltaY+=c;var e=this.limitX(this.deltaX),f=this.limitY(this.deltaY);return new h(e,f)},o.prototype.onScroll_=function(a){var b=this.calculatePosition_(0,0);a.clientX=this.clientX,a.clientY=this.clientY,this.doDrag(a,b.x,b.y,!0)},o.prototype.doDrag=function(a,b,c){this.defaultAction(b,c),this.dispatchEvent(new n(m.DRAG,this,a.clientX,a.clientY,a,b,c))},o.prototype.limitX=function(a){var b=this.limits,c=isNaN(b.left)?null:b.left,d=isNaN(b.width)?0:b.width,e=null!==c?c+d:1/0,f=null!==c?c:-1/0;return Math.min(e,Math.max(f,a))},o.prototype.limitY=function(a){var b=this.limits,c=isNaN(b.top)?null:b.top,d=isNaN(b.height)?0:b.height,e=null!==c?c+d:1/0,f=null!==c?c:-1/0;return Math.min(e,Math.max(f,a))},o.prototype.defaultAction=function(a,b){this.useRightPositioningForRtl_&&this.isRightToLeft_()?this.target.style.right=a+"px":this.target.style.left=a+"px",this.target.style.top=b+"px"},o.prototype.isDragging=function(){return this.dragging_},o});